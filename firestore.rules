rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /*
    ============================================================
    ğŸ” FIRESTORE SECURITY RULES â€” KREATASK
    Versi: v3.1 (sinkron dengan seed.js & seedRoles.js)
    ============================================================
    ğŸ“Œ Role Hierarchy:
      - roles_super_admin â†’ level tertinggi (akses penuh)
      - roles_admin â†’ manajemen data & user
      - roles_team_leader â†’ manajemen task tim
      - roles_team_member â†’ tugas pribadi
      - roles_unassigned â†’ setara dengan team_member (akses produktif dasar)
    ============================================================
    */

    // === ğŸ”‘ AUTH HELPER ===
    function isUserAuthenticated() {
      return request.auth != null;
    }

    function getUserRole(uid) {
      return exists(/databases/$(database)/documents/users/$(uid))
        ? get(/databases/$(database)/documents/users/$(uid)).data.role
        : "roles_unassigned";
    }

    // === ğŸ§­ ROLE CHECK FUNCTIONS ===
    function isSuperAdmin() {
      return isUserAuthenticated() &&
        getUserRole(request.auth.uid) == "roles_super_admin";
    }

    function isAdmin() {
      return isUserAuthenticated() && (
        getUserRole(request.auth.uid) == "roles_admin" ||
        isSuperAdmin()
      );
    }

    function isTeamLeader() {
      return isUserAuthenticated() && (
        getUserRole(request.auth.uid) == "roles_team_leader" ||
        isAdmin()
      );
    }

    // Unassigned dianggap sebagai member aktif (akses sama seperti team_member)
    function isTeamMember() {
      return isUserAuthenticated() && (
        getUserRole(request.auth.uid) == "roles_team_member" ||
        getUserRole(request.auth.uid) == "roles_unassigned" ||
        isTeamLeader()
      );
    }

    function isOwner(userId) {
      return isUserAuthenticated() && request.auth.uid == userId;
    }

    /*
    ============================================================
    ğŸ‘¤ USERS COLLECTION
    ------------------------------------------------------------
    - Pemilik akun dapat lihat & ubah datanya sendiri.
    - Admin dan SuperAdmin dapat melihat semua user.
    - Admin & SuperAdmin dapat hapus user lain (bukan dirinya sendiri).
    ============================================================
    */
    match /users/{userId} {
      allow get, update: if isOwner(userId);
      allow create: if isUserAuthenticated();
      allow list: if isAdmin();
      allow delete: if (isAdmin() || isSuperAdmin()) && request.auth.uid != userId;
    }

    /*
    ============================================================
    ğŸ“‹ TASKS COLLECTION
    ------------------------------------------------------------
    - SuperAdmin & Admin â†’ full access
    - TeamLeader â†’ kelola task timnya
    - TeamMember & Unassigned â†’ kelola task milik sendiri
    ============================================================
    */
    match /tasks/{taskId} {
      // Full access untuk SuperAdmin dan Admin
      allow read, list, create, update, delete: if isSuperAdmin() || isAdmin();

      // Team Leader dapat membuat dan mengubah task timnya
      allow read, list, create, update: if isTeamLeader();

      // Team Member & Unassigned hanya bisa kelola task mereka sendiri
      allow read: if isTeamMember() && request.auth.uid in resource.data.assigneesIds;
      allow list: if isTeamMember();
      allow create: if isTeamMember()
                    && request.resource.data.assigneesIds.size() == 1
                    && request.auth.uid in request.resource.data.assigneesIds;
      allow update: if isTeamMember() && request.auth.uid in resource.data.assigneesIds;
      // Tidak ada izin delete untuk member biasa
    }

    /*
    ============================================================
    ğŸ”” NOTIFICATIONS COLLECTION
    ------------------------------------------------------------
    - Setiap user hanya bisa baca / hapus notifikasinya sendiri.
    - Create hanya jika notifikasi miliknya sendiri.
    ============================================================
    */
    match /notifications/{notificationId} {
      allow read, delete: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
    }

    /*
    ============================================================
    âš™ï¸ SETTINGS COLLECTION
    ------------------------------------------------------------
    - Semua user bisa baca (tema, bahasa, preferensi UI)
    - SuperAdmin & Admin bisa ubah konfigurasi global
    ============================================================
    */
    match /settings/{settingId} {
      allow read: if isUserAuthenticated();
      allow create, update, delete: if isSuperAdmin() || isAdmin();
    }

    /*
    ============================================================
    ğŸ§© ROLES COLLECTION
    ------------------------------------------------------------
    - Semua user boleh baca (untuk UI dropdown & info role)
    - Hanya SuperAdmin boleh ubah atau tambah role sistem
    ============================================================
    */
    match /roles/{roleId} {
      allow read, list: if isUserAuthenticated();
      allow create, update, delete: if isSuperAdmin();
    }
  }
}
